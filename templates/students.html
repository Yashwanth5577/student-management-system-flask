{% extends "base.html" %}
{% block content %}

<!-- ===== PAGE TITLE ===== -->
<h3 class="section-title mb-4">
  <span class="icon-box">
    <i class="bi bi-people-fill"></i>
  </span>
  Registered Students
</h3>

<!-- ===== BRANCH FILTER (BACKEND ‚Äì KEEP AS IS) ===== -->
<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <h6 class="fw-bold mb-3">Branch-wise Student Count</h6>

    <a href="{{ url_for('view_students') }}"
       class="badge me-2 mb-2 px-4 py-2 {% if not selected_branch %} bg-dark {% else %} bg-secondary {% endif %}">
      All
    </a>

    {% for branch, count in branch_counts.items() %}
      <a href="{{ url_for('view_students', branch=branch) }}"
         class="badge me-2 mb-2 px-4 py-2 {% if selected_branch == branch %} bg-success {% else %} bg-primary {% endif %}">
        {{ branch }} : {{ count }}
      </a>
    {% endfor %}
  </div>
</div>

<!-- ===== DOWNLOAD + SEARCH + FILTER ===== -->
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-3">

  <!-- Download -->
  <a href="{{ url_for('download') }}" class="btn btn-success">
    <i class="bi bi-download"></i> Download Registered Students
  </a>

  <!-- Search -->
  <div class="flex-grow-1">
    <div class="input-group input-group-lg">
      <span class="input-group-text bg-primary text-white">üîç</span>
      <input type="text"
             id="searchInput"
             class="form-control"
             placeholder="Search student by name">
    </div>
  </div>

  <!-- Filter -->
  <div class="position-relative">
    <button id="filterBtn" class="btn btn-info text-white">
      ‚öô Filter
    </button>

    <div id="filterMenu" class="card shadow-sm position-absolute end-0 mt-2"
         style="display:none; width:230px; z-index:1000;">
      <div class="list-group list-group-flush">
        <button class="list-group-item" onclick="sortByName(true)">Alphabetical A ‚Üí Z</button>
        <button class="list-group-item" onclick="sortByName(false)">Alphabetical Z ‚Üí A</button>
        <button class="list-group-item" onclick="sortByRoll(true)">Roll Ascending</button>
        <button class="list-group-item" onclick="sortByRoll(false)">Roll Descending</button>
        <button class="list-group-item" onclick="sortByDate(true)">Newest First</button>
        <button class="list-group-item" onclick="sortByDate(false)">Oldest First</button>

        <div class="list-group-item fw-bold text-muted">Branch</div>
        {% for branch in branch_counts.keys() %}
          <button class="list-group-item" onclick="filterByBranch('{{ branch }}')">
            {{ branch }}
          </button>
        {% endfor %}

        <button class="list-group-item text-danger" onclick="resetTable()">
          Reset / Show All
        </button>
      </div>
    </div>
  </div>

</div>

<!-- ===== STUDENTS TABLE ===== -->
<div class="card shadow-lg">
  <div class="card-body p-4">
    <div class="table-responsive">
      <table class="table table-hover align-middle text-center" id="studentsTable">

        <thead class="table-dark">
          <tr>
            <th>Name</th>
            <th>Roll</th>
            <th>Branch</th>
            <th>Email</th>
            <th>Registered On</th>
            <th>Action</th>
          </tr>
        </thead>

        <tbody>
        {% for s in students %}
          <tr>
            <td>{{ s.name }}</td>
            <td>{{ s.roll }}</td>
            <td>{{ s.branch }}</td>
            <td>{{ s.email }}</td>
            <td data-date="{{ s.created_at }}">{{ s.created_at.strftime("%d %b %Y, %I:%M %p") }}</td>
            <td>
              <a href="/edit/{{ s.id }}" class="btn btn-warning btn-sm me-2">
                <i class="bi bi-pencil-square"></i>
              </a>
              <a href="/delete/{{ s.id }}"
                 onclick="return confirm('Are you sure you want to delete this student?')"
                 class="btn btn-danger btn-sm">
                <i class="bi bi-trash-fill"></i>
              </a>
            </td>
          </tr>
        {% endfor %}
        </tbody>

      </table>
    </div>
  </div>
</div>

<!-- ===== BACK BUTTON ===== -->
<div class="text-center mt-4">
  <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-lg">
    ‚¨Ö Back to Registration
  </a>
</div>

<!-- ===== FILTER & SEARCH SCRIPT ===== -->
<script>
const table = document.getElementById("studentsTable");
const tbody = table.querySelector("tbody");
const rows = Array.from(tbody.rows);

document.getElementById("filterBtn").onclick = () => {
  const menu = document.getElementById("filterMenu");
  menu.style.display = menu.style.display === "none" ? "block" : "none";
};

/* SEARCH */
document.getElementById("searchInput").addEventListener("keyup", function () {
  const value = this.value.toLowerCase();
  rows.forEach(row => {
    row.style.display = row.cells[0].innerText.toLowerCase().includes(value)
      ? ""
      : "none";
  });
});

/* SORTING */
function sortByName(asc) {
  sortTable(0, asc);
}
function sortByRoll(asc) {
  sortTable(1, asc, true);
}
function sortByDate(newest) {
  rows.sort((a, b) => {
    const d1 = new Date(a.cells[4].dataset.date);
    const d2 = new Date(b.cells[4].dataset.date);
    return newest ? d2 - d1 : d1 - d2;
  });
  rows.forEach(r => tbody.appendChild(r));
}

function sortTable(col, asc, numeric=false) {
  rows.sort((a, b) => {
    let A = a.cells[col].innerText;
    let B = b.cells[col].innerText;
    if (numeric) return asc ? A - B : B - A;
    return asc ? A.localeCompare(B) : B.localeCompare(A);
  });
  rows.forEach(r => tbody.appendChild(r));
}

/* FILTER */
function filterByBranch(branch) {
  rows.forEach(row => {
    row.style.display = row.cells[2].innerText === branch ? "" : "none";
  });
}

function resetTable() {
  rows.forEach(row => row.style.display = "");
}
</script>

{% endblock %}
