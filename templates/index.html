{% extends "base.html" %}
{% block content %}

<!-- ===== TOTAL STUDENTS ===== -->
<div class="stats-card text-center">
  <strong>Total Students:</strong> {{ students|length }}
</div>

<!-- ===== BRANCH COUNT (CLICKABLE FILTERS) ===== -->
<div class="card mb-5">
  <div class="card-body">
    <h6 class="fw-bold mb-3">Branch-wise Student Count</h6>

    <!-- ALL STUDENTS -->
    <a href="{{ url_for('index') }}"
       class="badge rounded-pill me-2 mb-2 px-4 py-2
       {% if not selected_branch %} bg-dark {% else %} bg-secondary {% endif %}">
      All
    </a>

    <!-- BRANCH BUTTONS -->
    {% for branch, count in branch_counts.items() %}
      <a href="{{ url_for('index', branch=branch) }}"
         class="badge rounded-pill me-2 mb-2 px-4 py-2
         {% if selected_branch == branch %} bg-success {% else %} bg-primary {% endif %}">
        {{ branch }} : {{ count }}
      </a>
    {% endfor %}
  </div>
</div>

<!-- ===== REGISTRATION TITLE ===== -->
<h3 class="section-title">
  <span class="icon-box">
    <i class="bi bi-person-plus-fill"></i>
  </span>
  Student Registration
</h3>

<!-- ===== REGISTRATION FORM ===== -->
<div class="card mb-5">
  <div class="card-body p-4">

    <form method="POST">

      <div class="mb-3">
        <input class="form-control form-control-lg"
               name="name"
               placeholder="Enter student name"
               required autofocus>
      </div>

      <div class="mb-3">
        <input class="form-control form-control-lg"
               name="roll"
               placeholder="Enter roll number"
               required>
      </div>

      <div class="mb-3">
        <select class="form-control form-control-lg" name="branch" required>
          <option value="">-- Select Branch --</option>
          <option value="CSE">CSE</option>
          <option value="CSE-AI">CSE-AI</option>
          <option value="CSE-AIML">CSE-AIML</option>
          <option value="CSE-DS">CSE-DS</option>
          <option value="CSE-ML">CSE-ML</option>
          <option value="CSE-CyberSecurity">CSE-CyberSecurity</option>
          <option value="ECE">ECE</option>
          <option value="EEE">EEE</option>
          <option value="Mechanical Engineering">Mechanical Engineering</option>
          <option value="Civil Engineering">Civil Engineering</option>
        </select>
      </div>

      <div class="mb-4">
        <input class="form-control form-control-lg"
               name="email"
               type="email"
               placeholder="Enter email address"
               required>
      </div>

      <div class="d-flex flex-wrap gap-3">
        <button id="registerBtn"
                class="btn btn-success"
                onclick="showLoading(this)">
          Register
        </button>

        <a href="/download" class="btn btn-primary">
          Download Excel
        </a>
      </div>

    </form>

  </div>
</div>

<hr class="my-5">

<!-- ===== SEARCH ===== -->
<form method="GET" class="mb-4">
  <input class="form-control form-control-lg"
         name="search"
         placeholder="Search student by name">
</form>

<!-- ===== STUDENT TABLE ===== -->
<div class="card">
  <div class="card-body p-4">

    <div class="table-responsive">
      <table class="table table-bordered align-middle">

        <thead>
          <tr>
            <th>Name</th>
            <th>Roll</th>
            <th>Branch</th>
            <th>Email</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
        </thead>

        <tbody>
        {% if students|length == 0 %}
          <tr>
            <td colspan="6" class="text-center text-muted py-4">
              No students found
            </td>
          </tr>
        {% else %}
          {% for s in students %}
          <tr>
            <td>{{ s.name }}</td>
            <td>{{ s.roll }}</td>
            <td>{{ s.branch }}</td>
            <td>{{ s.email }}</td>
            <td>{{ s.created_at.strftime("%d %b %Y, %I:%M %p") }}</td>
            <td>
              <a href="/edit/{{ s.id }}"
                 class="btn btn-warning btn-sm me-2">
                <i class="bi bi-pencil-square"></i>
              </a>

              <a href="/delete/{{ s.id }}"
                 onclick="return confirm('Are you sure you want to delete this student?')"
                 class="btn btn-danger btn-sm">
                <i class="bi bi-trash-fill"></i>
              </a>
            </td>
          </tr>
          {% endfor %}
        {% endif %}
        </tbody>

      </table>
    </div>

  </div>
</div>

<!-- ===== LOADING SPINNER ===== -->
<script>
  function showLoading(btn) {
    btn.disabled = true;
    btn.innerHTML = `
      <span class="spinner-border spinner-border-sm"></span>
      Registering...
    `;
    btn.form.submit();
  }
</script>

{% endblock %}
